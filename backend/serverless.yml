service: octillion-backend

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-1
  memorySize: 512
  timeout: 29
  iamRoleStatements:
    - Effect: Allow
      Action:
        - s3:PutObject
        - s3:GetObject
        - s3:ListBucket
      Resource:
        - arn:aws:s3:::octillion-bucket
        - arn:aws:s3:::octillion-bucket/*
  apiGateway:
    binaryMediaTypes:
      - "multipart/form-data"
  environment:
    NODE_ENV: production
    PORT: 5002
    SUPABASE_URL: https://mhioxkokqrdwaczantad.supabase.co
    SUPABASE_ANON_KEY: ${env:SUPABASE_ANON_KEY}
    SUPABASE_SERVICE_KEY: ${env:SUPABASE_SERVICE_KEY}
    SUPABASE_JWT_KEY: ${env:SUPABASE_JWT_KEY}
    S3_BUCKET_NAME: octillion-bucket
    QDRANT_URL: ${env:QDRANT_URL}
    QDRANT_API_KEY: ${env:QDRANT_API_KEY}
    OPENAI_API_KEY: ${env:OPENAI_API_KEY}
    FRONTEND_URL: https://octillion.vercel.app

functions:
  app:
    handler: src/lambda.handler
    events:
      - http:
          path: /{proxy+}
          method: ANY
          cors:
            origin: "https://octillion.vercel.app"
            headers:
              - Content-Type
              - Authorization
              - X-Amz-Date
              - X-Amz-Security-Token
              - X-Requested-With
              - X-Amz-User-Agent
              - X-Api-Key
            allowCredentials: true
      - http:
          path: /
          method: ANY
          cors:
            origin: "https://octillion.vercel.app"
            headers:
              - Content-Type
              - Authorization
              - X-Amz-Date
              - X-Amz-Security-Token
              - X-Requested-With
              - X-Amz-User-Agent
              - X-Api-Key
            allowCredentials: true

plugins:
  - serverless-offline

build:
  bundle: true
  minify: true
  exclude: ["aws-sdk"]
  target: node18

package:
  individually: true
  exclude:
    - node_modules/onnxruntime-web/**
    - node_modules/@esbuild/**
    - node_modules/@babel/**
    - node_modules/typescript/**
    - node_modules/java-invoke-local/**
    - node_modules/web-streams-polyfill/**
    - node_modules/aws-sdk/**
    - node_modules/.bin/**
    - node_modules/**/*.md
    - node_modules/**/*.map
    - node_modules/**/test*/**
    - node_modules/**/tests*/**
    - node_modules/**/*.test.js
    - node_modules/**/*.spec.js
    - node_modules/**/*.d.ts
    - src/**/*.test.js
    - tests/**
    - test/**
    - docs/**
    - .git/**
    - .env
    - logs/**
    - Dockerfile
    - .dockerignore
    - docker/**
    - README.md
    - package-lock.json
    - .npmrc
    - .vscode/**
    - coverage/**
