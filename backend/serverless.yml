service: octillion-backend

provider:
  name: aws
  runtime: nodejs20.x
  region: us-east-1
  architecture: x86_64

  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
            - s3:ListBucket
          Resource:
            - "arn:aws:s3:::${env:S3_BUCKET_NAME}"
            - "arn:aws:s3:::${env:S3_BUCKET_NAME}/*"
        - Effect: Allow
          Action:
            - lambda:InvokeFunction
          Resource:
            - "arn:aws:lambda:${self:provider.region}:*:function:${self:service}-${sls:stage}-processor"
            - "arn:aws:lambda:${self:provider.region}:*:function:${self:service}-${sls:stage}-geometry"
  environment:
    PORT: ${env:PORT, '5002'}
    SUPABASE_URL: ${env:SUPABASE_URL}
    SUPABASE_ANON_KEY: ${env:SUPABASE_ANON_KEY}
    SUPABASE_SERVICE_KEY: ${env:SUPABASE_SERVICE_KEY}
    SUPABASE_JWT_KEY: ${env:SUPABASE_JWT_KEY}
    S3_BUCKET_NAME: ${env:S3_BUCKET_NAME}
    QDRANT_URL: ${env:QDRANT_URL}
    QDRANT_API_KEY: ${env:QDRANT_API_KEY}
    OPENAI_API_KEY: ${env:OPENAI_API_KEY}
    WORKER_FUNCTION_NAME: ${env:WORKER_FUNCTION_NAME}
    GEOMETRY_LAMBDA_NAME: ${env:GEOMETRY_LAMBDA_NAME}
    GROQ_API_KEY: ${env:GROQ_API_KEY}
    AXIOM_API_TOKEN: ${env:AXIOM_API_TOKEN}
    AXIOM_DATASET: ${env:AXIOM_DATASET}
    GEOMETRY_SERVICE_URL: ${env:GEOMETRY_SERVICE_URL}
    UPSTASH_REDIS_URL: ${env:UPSTASH_REDIS_URL}
    UPSTASH_REDIS_TOKEN: ${env:UPSTASH_REDIS_TOKEN}
    NODE_ENV: ${env:NODE_ENV}
    GEOMETRY_PROMOTION_THRESHOLD: ${env:GEOMETRY_PROMOTION_THRESHOLD, '100'}
    GEOMETRY_REDIS_TTL: ${env:GEOMETRY_REDIS_TTL, '86400'}
    S3_REGION: ${env:S3_REGION}

functions:
  api:
    image: 589820791139.dkr.ecr.us-east-1.amazonaws.com/serverless-octillion-backend-dev@sha256:3e8ce14f24548c76d8beddae56b4f82ffd947e38ac0eb0165a0b6e8d651af249
    memorySize: 2048
    events:
      - http:
          path: /
          method: ANY
      - http:
          path: /{proxy+}
          method: ANY

  processor:
    image: 589820791139.dkr.ecr.us-east-1.amazonaws.com/serverless-octillion-backend-dev@sha256:3e8ce14f24548c76d8beddae56b4f82ffd947e38ac0eb0165a0b6e8d651af249
    timeout: 900
    memorySize: 3008

  geometry:
    image: 589820791139.dkr.ecr.us-east-1.amazonaws.com/serverless-octillion-geometry-dev@sha256:5edeebe99752b789d24eeaafbdee9f16a5d06392c164c8a15004778c24327bd4
    memorySize: 3008
    environment:
      TRANSFORMERS_CACHE: /tmp/transformers_cache
      HF_HOME: /tmp/huggingface
      TORCH_HOME: /tmp/torch
